Title: Une bassine de travail
Tags: docker, bassine, pair-programming
Author: Olivier, Etienne
Summary: Comment utiliser un conteneur Docker pour faire une zone de travail collaboratif.
Status: draft

Depuis quelque temps, nous expérimentons le pair programming à distance. Pour partager l'écran, nous utilisons une connexion ssh avec un tmux. Évidement ce n'est que du mode text, mais cela laisse quand meme la possibilité de débatre entre vim et emacs :)

# La bassine de base

Nous avons donc commencé par définir [une bassine de base](https://github.com/Deliverous/docker-bassine/tree/master/base). Le contenu du Dockerfile est trivial :


    FROM ubuntu:trusty

    ENV DEBIAN_FRONTEND noninteractive

    RUN \
    apt-get update \
    && apt-get dist-upgrade -y \
    && apt-get install -y \
        vim-scripts \
        vim-syntax-docker \
        vim-syntax-go \
        build-essential \
        byobu \
        ca-certificates \
        curl \
        git \
        man \
        mercurial \
        openssh-server \
        openssl \
        time \
        vim \
        vim-addon-manager \
        vim-nox \
    && apt-get clean \
    && locale-gen en_US.UTF-8 fr_FR.UTF-8 \
    && mkdir /var/run/sshd


On commence par installer les packages de base. A priori, ici, vim a pris le dessus sur emacs...


    RUN \
        adduser --disabled-login --gecos "Pierre D'eau,,," pierre \
        && adduser pierre sudo

    ADD sshd_config /etc/ssh/sshd_config
    ADD sudoers /etc/ssh/sudoers


On créé un utilisateur, pierre, et on configure sshd. Ce passage est sensible et notre première bassine a été hackée. L'idée içi est de ne s'authentifier que par clé ssh. Pour injecter ces clés, nous avons choisi de créer des images dérivant de base comme c'elle de [deliverous](https://github.com/Deliverous/docker-bassine/tree/master/deliverous). Nous verrons cela plus loin.


    ADD gitconfig /home/pierre/.gitconfig
    ADD vimrc /home/pierre/.vimrc
    ADD set-git-user /usr/local/bin/set-git-user
    RUN chmod 755 /usr/local/bin/set-git-user


On continue par ajouter des configurations pour git, vim et un script qui permet de configurer l'utilisateur dans git.


    EXPOSE 22

    CMD ["/usr/sbin/sshd", "-D"]


Et on fini avec le service ssh et son port.


# La bassine deliverous

Pour notre project deliverous, nous avons construit une bassine [deliverous](https://github.com/Deliverous/docker-bassine/tree/master/deliverous). En voici le Dockerfile :


    FROM registry.deliverous.net/deliverous/docker-bassine:0.1.0-0

    ENV GOVERSION 1.3.3
    ENV RUBYVERSION 2.1.5

    RUN \
        apt-get update \
        && apt-get install -y qt4-dev-tools qt4-qmake \
        && apt-get clean \

    RUN \
        curl -sSL https://golang.org/dl/go$GOVERSION.src.tar.gz  | tar -v -C /usr/src -xz \
        && cd /usr/src/go/src \
        && ./make.bash --no-clean \
        && rm -rf /usr/src/go


On commence par installer Go.


    USER pierre

    RUN \
        gpg --keyserver hkp://keys.gnupg.net --recv-keys D39DC0E3 \
        && \curl -sSL https://get.rvm.io | bash -s stable \
        && /bin/bash -l -c "rvm requirements" \
        && /bin/bash -l -c "rvm install ruby-$RUBYVERSION" \
        && /bin/bash -l -c "rvm use --default ruby-$RUBYVERSION"


Ensuite, on installe Ruby à travers rvm


    USER root

    ADD get-deliverous /usr/local/bin/get-deliverous
    RUN chmod 755 /usr/local/bin/get-deliverous


On rajoute un script qui nous permet de mettre à jour notre workspace


    ADD authorized_keys /home/pierre/.ssh/authorized_keys
    RUN chown -R pierre:pierre /home/pierre/


On déploie les clé ssh pour l'utilisateur pierre


    RUN \
        git clone https://github.com/mnagel/clustergit /usr/local/src/clustergit \
        && ln -s /usr/local/src/clustergit/clustergit /usr/local/bin/clustergit


On déploie clustergit qui est bien pratique pour mettre à jours une arborescence de repo git.


    VOLUME ["/home/pierre/workspace"]
    CMD ["/usr/sbin/sshd", "-D"]



---
Photo par [tetue](https://www.flickr.com/photos/romytetue/109188206)
