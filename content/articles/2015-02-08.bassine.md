Title: Une bassine de travail
Tags: docker, bassine, pair-programming
Author: Olivier, Etienne
Summary: Comment utiliser un conteneur Docker pour faire une zone de travail collaboratif.
Status: draft

Depuis quelque temps, nous expérimentons le pair programming à distance. Pour partager l'écran, nous utilisons une connexion ssh avec un tmux. Évidement ce n'est que en mode text, mais cela laisse quand meme la possibilité de débatre entre vim et emacs :)

# La bassine de base

Nous avons donc commencé par définir [une bassine de base](https://github.com/Deliverous/docker-bassine/tree/master/base). Le contenu du Dockerfile est trivial :


    FROM ubuntu:trusty

    ENV DEBIAN_FRONTEND noninteractive

    RUN \
        apt-get update \
        && apt-get install -y \
            vim-scripts \
            vim-syntax-docker \
            vim-syntax-go \
            build-essential \
            byobu \
            ca-certificates \
            curl \
            git \
            man \
            mercurial \
            openssh-server \
            openssl \
            time \
            vim \
            vim-addon-manager \
            vim-nox \
        && locale-gen en_US.UTF-8 fr_FR.UTF-8


On commence par installer les packages de base. A priori, ici, vim a pris le dessus sur emacs....


    RUN \
        adduser --disabled-login --gecos "Pierre D'eau,,," pierre \
        && adduser pierre sudo \
        && sed -ri 's/^%sudo\s+.*/%sudo  ALL=(ALL:ALL) NOPASSWD:ALL/' /etc/sudoers \
        \
        && mkdir /var/run/sshd \
        && sed -ri 's/^PermitRootLogin\s+.*/PermitRootLogin no/' /etc/ssh/sshd_config \
        && sed -ri 's/UsePAM\s+.*/UsePAM no/g' /etc/ssh/sshd_config \
        && sed -ri 's/ChallengeResponseAuthentication\s+.*/ChallengeResponseAuthentication no/g' /etc/ssh/sshd_config \
        && sed -ri 's/PasswordAuthentication\s+.*/PasswordAuthentication no/g' /etc/ssh/sshd_config \
        && echo "AllowUsers pierre" >> /etc/ssh/sshd_config


On créé un utilisateur, pierre, et on configure sshd. Ce passage est sensible et notre première bassine a été hackée. L'idée içi est de ne s'authentifier que par clé ssh. Pour injecter ces clés, nous avons choisi de créer des images dérivant de base comme c'elle de [deliverous](https://github.com/Deliverous/docker-bassine/tree/master/deliverous).


    ADD gitconfig /home/pierre/.gitconfig
    ADD vimrc /home/pierre/.vimrc
    ADD set-git-user /usr/local/bin/set-git-user
    RUN chmod 755 /usr/local/bin/set-git-user


On continue par ajouter des configurations pour git, vim et un script qui permet de configurer l'utilisateur dans git.


    EXPOSE 22

    CMD ["/usr/sbin/sshd", "-D"]


Et on fini avec le service ssh et son port.

---
Photo par [tetue](https://www.flickr.com/photos/romytetue/109188206)
