Title: Comment faire un container tomcat
Tags: docker, centos, tomcat
Author: Thomas
Summary: Confronté à un problème de construction de container tomcat, voici quelques pistes pour bien commencer. 
Status: draft
Icon: /images/thumbnails/2014-07-31.docker-tomcat.tomcat__square.jpg

Non, je ne vais pas vous parler des F14 Tomcat de Top Gun, mais bien de container Docker et d'Apache Tomcat.
Alors construisons ensemble quelques containers.

![Cluster]({filename}/images/2014-07-31.docker-tomcat.tomcat.jpg)

# Une base de CentOS

En partant d'une distribution de base, il est facile d'installer tomcat. Avec une Debian stable il est même possible de choisir entre tomcat 6 et tomcat 7. Avec une CentOS 6, c'est encore plus simple, il n'y a pas de choix possible : 

    yum install tomcat6

Avec une CentOS 7 c'est tout aussi simple, le rpm s'appel tomcat et c'est un tomcat 7.

# Des RPMs

Dans beaucoup d'entreprise, les logiciels s'installent uniquement depuis les rpms officiels, une façon simple de suivre les mises à jour de sécurités et de réduire les coûts de maintenances.
Dans ces conditions, si l'on souhaite un tomcat 6 avec un java 7, il faut partir d'une CentOS 6. Le Dockerfile va donc commencer par :

```
FROM centos:centos6
RUN yum -y upgrade && yum clean all
RUN yum -y install java-1.7.0-openjdk && yum clean all
RUN yum -y install tomcat6 && yum clean all
```

Jusque-là, rien de très compliqué. Il reste à :

* ajouter une application,
* exposer le bon port,
* et lancer tomcat

Ce dernier point présente une petite difficulté, en effet, le script de boot de tomcat lance le serveur d'application en mode démon... seulement Docker s'attend a lancer un processus qui ne se détache pas. Pour éviter d'avoir à refaire et surtout d'avoir à maintenir un nouveau script startup.sh il est possible de lancer juste après Tomcat un second processus qui gardera la main. Par exemple un tail de l'ensemble des fichiers logs. Le tail apporte en plus la possibilité de consulter les logs du tomcat avec un simple "docker logs", ce qui est fort pratique. 

La suite de notre Dockerfile est donc la suivante : 

```
ADD http://tomcat.apache.org/tomcat-6.0-doc/appdev/sample/sample.war /var/lib/tomcat6/webapps/
EXPOSE 8080
CMD service tomcat6 start && tail -f /var/log/tomcat6/*
```

Pour construire notre container, il suffit de lancer

    docker build -t tomcat6-centos6 .

Puis de le lancer sans oublier d'exposer le port 8080 :

    docker run -p 8080:8080 tomcat6-centos6

Et enfin, visitez [http://localhost:8080/sample/](http://localhost:8080/sample/) pour admirer votre travail.

# L'archive officielle

Pour partir de l'archive officielle distribuée par Apache, le choix de la distribution de base n'a pas d'importance. Je propose donc de partir de la dernière CentOS :

```
FROM centos
MAINTAINER Thomas Clavier <tclavier@azae.net>
RUN yum upgrade -y && yum clean all
RUN yum -y install java-1.7.0-openjdk && yum clean all
RUN yum -y install tar && yum clean all

ADD http://mir1.ovh.net/ftp.apache.org/dist/tomcat/tomcat-7/v7.0.54/bin/apache-tomcat-7.0.54.tar.gz /tmp/
RUN mkdir /opt/tomcat
RUN tar -xzvf /tmp/apache-tomcat-7.0.54.tar.gz --directory /opt/tomcat/ --strip 1 && rm /tmp/apache-tomcat-7.0.54.tar.gz

ADD http://tomcat.apache.org/tomcat-6.0-doc/appdev/sample/sample.war /opt/tomcat/webapps/

EXPOSE 8080

CMD service tomcat6 start && tail -f /opt/tomcat/logs/*
```



# Normalisation

Imaginons que votre container Tomcat va tourner dans un environnement de production normalisé, pour que les fichiers de logs soit simple à trouver il faudrait par systématiquement mettre les logs dans le même répertoire et que ce répertoire soit déclaré comme un volume, ainsi la production pourra facilement centraliser les logs de tous les containers. Je propose de systématiquement logger dans /var/log/tomcat.

## RPM

Avec le tomcat 6 de CentOS les logs sont dans /var/log/tomcat6 ... changeons ça : 

## Archive

---
Photo par [storem](https://www.flickr.com/photos/storem/3198300643/)
