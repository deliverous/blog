Title: Vous avez dit volumes ? 
Tags: docker, volume, deliverous, uploads
Authors: Thomas Clavier
Summary: Quelles sont les bonnes pratiques avec les volumes ? Suite de la série sur les volumes.
Status: draft

Dans cet article, le second de la série sur les volumes, je vais aborder un nouvel usage des volumes : les 

# Des dossiers séparés

Il est aussi possible d'utiliser les volumes pour différencier sur
l'hyperviseur des données provenant de différentes instances du même conteneur.
Par exemple pour identifier les logs des instances de différents clients. 

Prenons l'exemple d'un conteneur avec une application qui log tout dans
/var/log/application/ avec les options de montage des volumes il est possible
de lancer 3 fois cette même applications et de sauver les fichiers générés dans
3 répertoires différents : 

    :::shell
    docker run -v /data/application1/logs:/var/log/application --name application1 conteneur
    docker run -v /data/application2/logs:/var/log/application --name application2 conteneur
    docker run -v /data/application3/logs:/var/log/application --name application3 conteneur

Ce mode de fonctionnement peut aussi être utilisé pour différencier différentes
instances d'un même conteneur. Prenons l'exemple d'une application qui lit et
écrit l'ensemble de ses données applicatives dans /home/application. Il est
possible de dédier chaque instance à un usage donné. 

    :::shell
    docker run -v /data/application1:/home/application --name application1 conteneur
    docker run -v /data/application2:/home/application --name application2 conteneur

Avec cette configuration, chaque conteneur va pouvoir vivre sa vie avec ses propres données.

# Des utilisateurs

Il n'est pas rare d'avoir un conteneur qui lance une application avec un
utilisateur particulier. Il va donc écrire ses fichiers dans le volume avec
l'utilisateur en question :

    :::dockerfile
    user tomcat
    cmd /opt/tomcat/bin/catalina.sh start

Mais comment garantir que l'utilisateur tomcat dans le conteneur va bien avoir
le droit d'écrire dans un volume géré par l'hyperviseur ? 
Un conteneur doit être idempotent, on doit pouvoir le lancer sur n'importe quel serveur Docker sans avoir à présupposer de l'existence ou de la configuration du serveur. Il existe 2 solutions pour ça : 
- rendre le conteneur totalement autonome
- ou déployer le conteneur avec un conteneur de données 

## Un conteneur autonome

Impossible de supposer que les droits sur le volume sont correctement
configurés, le conteneur doit donc le configurer au démarrage. Le script de
lancement sera lancé en root comme tous les scripts de boot lancés par systemV.
Et dans ce script il sera possible de corriger les droits sur le volume avant
de lancer le service avec le bon utilisateur.

Exemple : 

    :::dockerfile
    cmd chown tomcat:tomcat /opt/tomcat/logs && \
        su tomcat -c "/opt/tomcat/bin/catalina.sh start"
    
Le défaut de ce système c'est l'incapacité d'anticiper l'identifiant de
l'utilisateur dans le conteneur. Imaginons que tous les conteneurs lancent
tomcat en écoute sur le port 8080 et log dans le volume /var/log/tomcat 



---
Photo par [tetue](https://www.flickr.com/photos/romytetue/109188206)
